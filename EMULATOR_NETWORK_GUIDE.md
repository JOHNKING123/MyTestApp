# Android模拟器网络配置指南

## 模拟器网络架构

### 网络地址分配
- **`10.0.2.2`** - 主机（你的电脑）IP地址
- **`10.0.2.1`** - 网关地址
- **`10.0.2.3`** - DNS服务器地址
- **`10.0.2.15`** - 模拟器自身IP地址

### 网络连通性特点
1. **单向通信**：模拟器可以访问主机，主机无法直接访问模拟器
2. **网络隔离**：每个模拟器实例有独立的网络空间
3. **端口限制**：需要通过端口转发建立双向通信

## P2P通信解决方案

### 方案1：端口转发（推荐）

#### 步骤1：设置端口转发
```bash
# 为群组创建者（模拟器A）设置端口转发
adb -s emulator-5554 forward tcp:8080 tcp:36324

# 为群组成员（模拟器B）设置端口转发
adb -s emulator-5556 forward tcp:8081 tcp:36324
```

#### 步骤2：修改P2P服务配置
应用已自动检测模拟器环境并使用正确的地址：
- 群组创建者：使用 `10.0.2.2:36324`
- 群组成员：连接到 `10.0.2.2:36324`

#### 步骤3：测试连接
```bash
# 测试端口转发是否成功
nc -zv 127.0.0.1 8080  # 群组创建者
nc -zv 127.0.0.1 8081  # 群组成员
```

### 方案2：使用真实IP地址

如果两个模拟器在同一台机器上，可以使用真实IP：

1. **获取主机真实IP**：
   ```bash
   ifconfig | grep "inet " | grep -v 127.0.0.1
   ```

2. **修改P2P服务配置**：
   - 使用真实IP地址而不是 `10.0.2.15`

## 测试流程

### 1. 群组创建者（模拟器A）
```bash
# 设置端口转发
adb -s emulator-5554 forward tcp:8080 tcp:36324

# 启动应用并创建群组
# 查看日志确认P2P服务器启动
```

### 2. 群组成员（模拟器B）
```bash
# 设置端口转发
adb -s emulator-5556 forward tcp:8081 tcp:36324

# 启动应用并扫描二维码
# 查看网络诊断日志
```

## 常见问题

### 问题1：连接被拒绝
**原因**：端口转发未设置或P2P服务器未启动
**解决**：
1. 检查端口转发设置
2. 确认P2P服务器已启动
3. 查看应用日志

### 问题2：网络连通性测试失败
**原因**：模拟器网络配置问题
**解决**：
1. 重启模拟器
2. 重新设置端口转发
3. 检查防火墙设置

### 问题3：端口转发失败
**原因**：端口被占用或权限问题
**解决**：
1. 使用不同的端口号
2. 检查adb连接状态
3. 重启adb服务

## 调试命令

### 检查设备连接
```bash
adb devices
```

### 查看端口转发状态
```bash
adb -s emulator-5554 forward --list
```

### 测试网络连通性
```bash
# 测试端口转发
nc -zv 127.0.0.1 8080

# 测试模拟器网络
adb -s emulator-5554 shell ping 10.0.2.2
```

### 查看网络接口
```bash
adb -s emulator-5554 shell ip addr show
```

## 注意事项

1. **端口转发是临时的**：重启模拟器后需要重新设置
2. **端口冲突**：确保不同模拟器使用不同端口
3. **防火墙**：确保主机防火墙允许相关端口
4. **网络权限**：确保应用有网络权限

## 自动化脚本

创建自动化脚本来设置端口转发：

```bash
#!/bin/bash
# setup_emulator_network.sh

echo "设置模拟器网络端口转发..."

# 获取模拟器设备ID
DEVICES=$(adb devices | grep emulator | cut -f1)

# 为每个模拟器设置端口转发
PORT=8080
for device in $DEVICES; do
    echo "为设备 $device 设置端口转发: $PORT -> 36324"
    adb -s $device forward tcp:$PORT tcp:36324
    PORT=$((PORT + 1))
done

echo "端口转发设置完成"
```

使用方法：
```bash
chmod +x setup_emulator_network.sh
./setup_emulator_network.sh
``` 
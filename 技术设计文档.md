# 技术设计文档（详细版补充）

## 1. 总体架构

### 1.1 架构图
- 展示端到端加密群聊的整体架构，包括各层次、数据流、密钥流转、P2P网络关系。

### 1.2 主要组件
- UI层：Flutter多端界面
- 业务逻辑层：群组、消息、用户、加密等核心逻辑
- 服务层：网络服务、加密服务、存储服务
- 数据层：本地数据库、密钥安全存储

## 2. 核心模块详细设计

### 2.1 群组管理
- 群组生命周期（创建、加入、退出、解散、密钥轮换）
- 群组元数据结构（ID、公钥、成员列表、会话密钥等）
- 二维码内容与安全性

### 2.2 用户与成员管理
- 用户身份标识（个人公钥/私钥）
- 成员加入/退出流程
- 权限模型（如后续支持管理员/普通成员）

### 2.3 消息系统
- 消息结构（ID、类型、加密内容、签名、时间戳、发送者ID等）
- 消息加密/解密流程
- 消息签名/验签流程
- 消息同步与重放保护

### 2.4 加密与密钥管理
- 群组密钥对生成与用途
- 会话密钥生成、分发、轮换、销毁
- 个人密钥对生成与用途
- 密钥分发协议（如RSA加密分发）
- 密钥存储（Keychain/Keystore/加密本地文件）

### 2.5 网络通信
- P2P连接建立（WebRTC/TCP/UDP）
- NAT穿透方案（STUN/TURN/UPnP）
- TLS加密传输
- 消息路由与广播机制
- 断线重连与消息重发

### 2.6 本地存储
- 消息本地缓存（SQLite/NoSQL）
- 密钥安全存储
- 群组与用户配置持久化

## 3. 关键流程时序图

### 3.1 群组创建与二维码生成
- 发起方生成群组密钥对、会话密钥
- 启动服务，生成二维码（仅含最小必要信息）

### 3.2 成员扫码加入
- 新成员扫码，获取发起方IP/端口/群组ID
- 新成员生成个人密钥对
- TLS连接发起方，发送加入请求
- 发起方用新成员公钥加密会话密钥分发

### 3.3 消息收发
- 发送方用会话密钥加密消息、个人私钥签名
- P2P TLS发送
- 接收方用会话密钥解密、用发送者公钥验签

### 3.4 密钥轮换
- 触发轮换（定期/成员变更）
- 生成新会话密钥
- 用每个成员公钥加密新密钥分发
- 成员收到后替换本地密钥

## 4. 安全设计

### 4.1 加密算法
- 非对称：RSA-2048/ECDSA
- 对称：AES-256-GCM
- 哈希：SHA-256

### 4.2 防护措施
- TLS加密传输
- 消息签名与验签
- 消息唯一ID与时间戳防重放
- 密钥定期轮换与成员变更轮换
- 本地密钥安全存储
- 敏感信息最小化原则

### 4.3 风险与应对
- 群组公钥泄露无风险
- 会话密钥泄露高风险，需严格保护
- 设备被攻破时的应急处理（密钥销毁、远程登出等）

## 5. 技术选型与依赖

- Flutter/Dart
- pointycastle/encrypt/crypto
- web_socket_channel / WebRTC
- sqflite/shared_preferences
- qr_flutter/qr_code_scanner
- 可能的STUN/TURN服务

## 6. 未来扩展

- 文件/图片/语音消息
- 多端同步与离线消息
- 群组权限细化
- 更丰富的安全策略与审计
- 支持桌面端、Web端

---

如需进一步细化某一部分（如详细时序图、接口定义、加密协议流程等），请告知！

---
*本设计文档为项目开发的技术蓝图，后续可根据实际需求持续完善。* 
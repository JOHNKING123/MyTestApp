# MyTestApp 技术设计文档

## 项目概述

MyTestApp 是一个基于 Flutter 的跨平台端到端加密群聊应用，采用纯分布式 P2P 架构，支持千人群聊。应用具有去中心化、端到端加密、实时消息同步等特性。

## 架构设计

### 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端A       │    │   客户端B       │    │   客户端C       │
│  (群组创建者)   │    │  (普通成员)     │    │  (普通成员)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   分布式P2P网络 │
                    │  (无中心服务器) │
                    └─────────────────┘
```

### 核心设计原则

1. **纯分布式架构**：无中心服务器，所有节点平等
2. **端到端加密**：消息在传输和存储过程中全程加密
3. **实时消息同步**：基于 WebSocket 的实时通信
4. **去中心化存储**：数据存储在本地，支持离线访问
5. **跨平台支持**：支持 Android、iOS、Web 平台

## 技术栈

### 前端技术
- **Flutter 3.0+**：跨平台 UI 框架
- **Provider**：状态管理
- **WebSocket**：实时通信
- **Hive**：本地数据存储
- **mobile_scanner**：二维码扫描

### 后端技术
- **Dart**：服务端语言
- **WebSocket**：P2P 通信协议
- **AES-256-GCM**：消息加密
- **ECDSA**：数字签名
- **SQLite/Hive**：本地存储

### 网络技术
- **P2P WebSocket**：节点间通信
- **分布式网络**：无中心化网络拓扑
- **消息广播**：高效的消息传播机制

## 数据模型设计

### 用户模型 (User)
```dart
class User {
  final String id;           // 用户唯一标识
  final String name;         // 用户名
  final UserProfile profile; // 用户资料
  final DateTime createdAt;  // 创建时间
  final String deviceId;     // 设备ID
}
```

### 群组模型 (Group)
```dart
class Group {
  final String id;           // 群组唯一标识
  final String name;         // 群组名称
  final String creatorId;    // 创建者ID
  final List<Member> members; // 成员列表
  final GroupKeyPair groupKeys; // 群组密钥对
  final SessionKey sessionKey;  // 会话密钥
  final GroupStatus status;     // 群组状态
  final int maxMembers;         // 最大成员数 (1000)
}
```

### 消息模型 (Message)
```dart
class Message {
  final String id;           // 消息唯一标识
  final String groupId;      // 群组ID
  final String senderId;     // 发送者ID
  final MessageContent content; // 消息内容
  final DateTime timestamp;  // 发送时间
  final MessageType type;    // 消息类型
  final String signature;    // 数字签名
}
```

## 分布式P2P网络设计

### 网络拓扑

#### 连接策略
- **每个节点连接数量**：8-12个其他节点
- **连接选择标准**：
  - 地理位置近的节点 (3-4个) - 低延迟
  - 网络状况好的节点 (3-4个) - 高带宽
  - 历史稳定的节点 (2-3个) - 可靠性
  - 随机选择的节点 (1-2个) - 网络多样性

#### 小世界网络模型
```
节点A ←→ 节点B ←→ 节点C
  ↓        ↓        ↓
节点D ←→ 节点E ←→ 节点F
  ↓        ↓        ↓
节点G ←→ 节点H ←→ 节点I
```

### 消息传播机制

#### 分层扩散算法
```
第0层：消息源节点
第1层：直接连接的8个节点 (1跳)
第2层：第1层节点的邻居 (2跳)
第3层：第2层节点的邻居 (3跳)
...
```

#### 传播优化策略
- **并行传播**：同时向多个邻居发送
- **去重机制**：通过消息ID避免重复传播
- **TTL控制**：消息生存时间，防止无限传播
- **优先级队列**：重要消息优先传播

### 主节点群机制

#### 主节点数量：5-8个

#### 选择标准
- **在线时长**：> 24小时
- **网络带宽**：> 10Mbps
- **设备性能**：CPU使用率 < 50%
- **地理位置**：分布在不同地区

#### 职责分工
- **新成员接入**：处理新成员加入请求
- **网络维护**：监控网络健康状况
- **消息协调**：协调大规模消息传播

## 安全设计

### 加密体系

#### 密钥层次
1. **用户密钥对**：ECDSA 密钥对，用于身份验证
2. **群组密钥对**：群组级别的加密密钥
3. **会话密钥**：临时会话密钥，定期更新

#### 消息加密流程
```
明文消息 → AES-256-GCM加密 → 密文消息
         ↓
    会话密钥加密 → 群组公钥加密
```

### 身份验证

#### 连接验证
- **用户身份验证**：验证用户是否为群组成员
- **群组有效性验证**：验证群组是否存在且有效
- **设备验证**：验证设备ID的合法性

#### 消息验证
- **数字签名**：ECDSA 签名验证消息完整性
- **时间戳验证**：防止重放攻击
- **序列号验证**：确保消息顺序

## 性能设计

### 目标性能指标

#### 消息传播性能
- **传播延迟**：< 2秒到达所有节点
- **传播覆盖率**：> 99%的节点能收到消息
- **网络负载**：每个节点带宽使用 < 1Mbps
- **故障恢复**：< 30秒内恢复网络连通性

#### 系统性能
- **并发连接**：支持1000个并发节点
- **消息吞吐量**：> 1000条消息/分钟
- **内存使用**：< 100MB/节点
- **CPU使用率**：< 30%

### 优化策略

#### 网络优化
- **连接质量评估**：动态评估连接质量
- **智能路由**：选择最优传播路径
- **负载均衡**：平衡网络负载分布

#### 消息优化
- **消息批处理**：批量处理小消息
- **压缩传输**：消息内容压缩
- **智能缓存**：本地消息缓存

## 存储设计

### 本地存储

#### 数据分类
- **用户数据**：用户信息、密钥等
- **群组数据**：群组信息、成员列表等
- **消息数据**：聊天记录、文件等
- **网络数据**：连接信息、路由表等

#### 存储策略
- **SQLite**：结构化数据存储
- **Hive**：高性能键值存储
- **文件系统**：大文件存储

### 数据同步

#### 同步机制
- **增量同步**：只同步变化的数据
- **冲突解决**：基于时间戳的冲突解决
- **离线支持**：支持离线消息存储

## 错误处理

### 网络错误处理

#### 连接错误
- **自动重连**：连接断开时自动重连
- **故障转移**：主节点故障时切换到备用节点
- **网络分区处理**：处理网络分区情况

#### 消息错误
- **消息重传**：重要消息失败时重传
- **消息确认**：关键消息需要确认机制
- **错误恢复**：从错误状态恢复

### 应用错误处理

#### 异常处理
- **全局异常捕获**：捕获未处理的异常
- **错误日志**：记录详细的错误信息
- **用户友好提示**：向用户显示友好的错误信息

## 监控和日志

### 监控指标

#### 网络监控
- **连接状态**：节点连接状态监控
- **消息传播**：消息传播延迟和成功率
- **网络负载**：网络带宽和CPU使用率

#### 应用监控
- **用户活跃度**：用户在线时长和消息发送频率
- **群组活跃度**：群组消息数量和成员活跃度
- **系统性能**：内存使用、CPU使用率等

### 日志系统

#### 日志级别
- **DEBUG**：详细的调试信息
- **INFO**：一般信息
- **WARN**：警告信息
- **ERROR**：错误信息

#### 日志内容
- **网络日志**：连接、消息传播等网络相关日志
- **安全日志**：加密、认证等安全相关日志
- **性能日志**：性能指标和优化相关日志

## 部署和运维

### 开发环境

#### 环境要求
- **Flutter SDK**：3.0+
- **Dart SDK**：3.0+
- **Android Studio**：最新版本
- **Xcode**：最新版本（iOS开发）

#### 开发工具
- **VS Code**：代码编辑器
- **Git**：版本控制
- **Postman**：API测试

### 测试策略

#### 单元测试
- **服务层测试**：测试各个服务的功能
- **模型层测试**：测试数据模型的正确性
- **工具类测试**：测试工具类的功能

#### 集成测试
- **P2P网络测试**：测试网络连接和消息传播
- **加密功能测试**：测试加密和解密功能
- **UI交互测试**：测试用户界面交互

#### 性能测试
- **负载测试**：测试系统在高负载下的表现
- **压力测试**：测试系统的极限承载能力
- **稳定性测试**：测试系统的长期稳定性

## 版本规划

### 当前版本 (v1.0)
- [x] 基础P2P通信
- [x] 端到端加密
- [x] 群组管理
- [x] 消息发送接收
- [x] 二维码扫码加入

### 下一版本 (v1.1)
- [ ] 分布式P2P网络
- [ ] 千人群聊支持
- [ ] 消息广播优化
- [ ] 网络拓扑管理
- [ ] 主节点群机制

### 未来版本 (v2.0)
- [ ] 文件传输功能
- [ ] 语音消息支持
- [ ] 群组权限管理
- [ ] 消息撤回功能
- [ ] 高级安全特性

## 技术债务

### 当前技术债务
1. **消息处理回调**：需要完善消息处理链路
2. **连接管理**：需要优化连接断开和重连机制
3. **错误处理**：需要完善错误处理和恢复机制
4. **性能优化**：需要优化大规模群聊的性能

### 解决计划
1. **短期**：修复消息处理回调问题
2. **中期**：实现分布式P2P网络
3. **长期**：优化性能和用户体验

## 总结

MyTestApp 采用纯分布式P2P架构，通过创新的网络拓扑设计和消息传播机制，能够支持千人群聊。系统具有良好的扩展性、安全性和可靠性，为用户提供高质量的群聊体验。 